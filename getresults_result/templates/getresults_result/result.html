{% extends 'getresults_result/home.html'%}
{% load crispy_forms_tags %}

{% block section_labels%}{% endblock section_labels%}

{% block section_body_one %}
<div class="table-responsive">
<table class="table table-striped">
<thead>
<th>Visit</th> 
<th>Collection</th> 
<th>Condition</th>
<th>Aliquot</th>     
<th>Ordered</th>     
<th>Order</th>     
</thead>
<tbody>
  <tr>
     <td>{{ visit }}</td>             
     <td>{{ order.aliquot.receive.collection_datetime|date:"Y-m-d H:i" }}</td>             
     <td>{{ order.aliquot.aliquot_condition }}</td>
     <td>{{ order.aliquot.aliquot_identifier }}</A></td>
     <td>{{ order.order_datetime|date:"Y-m-d" }}</td>             
     <td>{{ order.order_identifier }}</td>             
    </tr>                           
</tbody>
</table>
</div>
{% endblock section_body_one %}
{% block section_body_table %}
	<form action="{{ request.path }}" method="POST">
	{% csrf_token %}
	{{ validation_formset.management_form }}
	<table class="table table-striped">
	<thead>
    <tr>
	<th>#</th>
	<th>Analyte</th>
	<th>Value</th>    
	<th>Ref</th>
	<th>Flags</th>
	<th>Date</th>
	<th colspan="2">Validation</th>
	<th>#</th>
    </tr>
	</thead>
	<tbody>
	{% for form in validation_formset %}
	  <tr>
	    {% if is_paginated %}
	    	<td>{{ forloop.counter|add:page_obj.start_index|add:-1 }}</td>
	    {% else %}
	    	<td>{{ forloop.counter }}</td>
	   	{% endif %}
		<td>{{ form.instance.utestid }}</td> 
		<td>{% if form.quantifier.value != '=' %}{{ form.quantifier.value }}{% endif %}{{ form.value.value }}&nbsp;{{ form.utestid.units|default:'' }}</td>
		<td>ref?</td>
		<td>flag?</td>
		<td>{{ form.result_datetime.value|date:"Y-m-d" }}</td>                
		<td>
			{% if form.status.value %}
				<a onclick="displayStatus('accept', {{ forloop.counter|add:-1 }})"><span id="accept_{{ forloop.counter|add:-1 }}" class="glyphicon glyphicon-ok {% if form.status != 'accept' %}text-success{% endif %}"></span></a>
				<a onclick="displayStatus('reject', {{ forloop.counter|add:-1 }})"><span id="reject_{{ forloop.counter|add:-1 }}" class="glyphicon glyphicon-remove {% if form.status != 'reject' %}text-success{% endif %}"></span></a>
				<a onclick="displayStatus('repeat', {{ forloop.counter|add:-1 }})"><span id="repeat_{{ forloop.counter|add:-1 }}" class="glyphicon glyphicon glyphicon-repeat {% if form.status != 'repeat' %}text-success{% endif %}"></span></a>
				<a onclick="displayStatus('ignore', {{ forloop.counter|add:-1 }})"><span id="ignore_{{ forloop.counter|add:-1 }}" class="glyphicon glyphicon-question-sign {% if form.status != 'ignore' %}text-success{% endif %}"></span></a>
			{% else %}
				<div id='validation_status'>
				<span id="accept_{{ forloop.counter|add:-1 }}" class="glyphicon glyphicon-ok text-muted" onclick="displayStatus('accept', {{ forloop.counter|add:-1 }})" ></span>
				<span id="reject_{{ forloop.counter|add:-1 }}" class="glyphicon glyphicon-remove text-muted" onclick="displayStatus('reject', {{ forloop.counter|add:-1 }})"></span>
				<span id="repeat_{{ forloop.counter|add:-1 }}" class="glyphicon glyphicon glyphicon-repeat text-muted" onclick="displayStatus('repeat', {{ forloop.counter|add:-1 }})"></span>
				<span id="ignore_{{ forloop.counter|add:-1 }}" class="glyphicon glyphicon-question-sign text-muted" onclick="displayStatus('ignore', {{ forloop.counter|add:-1 }})"></span>
				</div>
			{% endif %}
		</td>
		<td>
			{{ form }}
			<span id="validation_status_text_{{ forloop.counter|add:-1 }}" class='text-danger bg-danger'>--------</span>
		</td>
	    {% if is_paginated %}
	    	<td>{{ forloop.counter|add:page_obj.start_index|add:-1 }}</td>
	    {% else %}
	    	<td>{{ forloop.counter }}</td>
	   	{% endif %}
	  </tr>
	{% endfor %}
	</tbody>
	</table>
	<button class="btn btn-primary btn-sm active" type="submit" id="submit_save">Save</button>
	<button class="btn btn-default btn-sm" type="submit" id="submit_savenext">Save Next</button>
	</form>
	<script>
		function displayStatus(status,n) {
		    ele=document.getElementById("validation_status_text_" + n)
		    ele.innerHTML=status
		    ele.classList.remove('bg-danger');
		    ele.classList.remove('text-danger');
		    ele.classList.remove('text-warning');
		    ele.classList.remove('text-info');
		    ele.classList.remove('text-success');
		    if(status=='reject'){ele.classList.add('text-danger');}
		    if(status=='accept'){ele.classList.add('text-success');}
		    if(status=='repeat'){ele.classList.add('text-info');}
		    if(status=='ignore'){ele.classList.add('text-warning');}
		    document.getElementById("id_form-"+n+"-status").value = status;
		    document.getElementById('accept_'+n).classList.remove('text-success')
		    document.getElementById('reject_'+n).classList.remove('text-danger');
		    document.getElementById('ignore_'+n).classList.remove('text-warning');
		    document.getElementById('repeat_'+n).classList.remove('text-info');
		    document.getElementById('accept_'+n).classList.add('text-muted');
		    document.getElementById('reject_'+n).classList.add('text-muted');
		    document.getElementById('ignore_'+n).classList.add('text-muted');
		    document.getElementById('repeat_'+n).classList.add('text-muted');
		    selected=document.getElementById(status+'_'+n)
		    if(status=='reject'){selected.classList.add('text-danger');}
		    if(status=='accept'){selected.classList.add('text-success');}
		    if(status=='repeat'){selected.classList.add('text-info');}
		    if(status=='ignore'){selected.classList.add('text-warning');}
		}
	</script>
{% endblock section_body_table %}